name: Test SSH connectivity

on:
    workflow_dispatch:

permissions:
    contents: read

jobs:
    test-ssh:
        runs-on: ubuntu-latest
        steps:
            - name: Validate SSH secrets
              shell: bash
              env:
                  DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
                  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
                  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
                  SSH_PORT: ${{ secrets.SSH_PORT }}
              run: |
                  set -euo pipefail
                  if [ -z "${DEPLOY_HOST:-}" ]; then echo "Error: DEPLOY_HOST secret is not set"; exit 1; fi
                  if [ -z "${DEPLOY_USER:-}" ]; then echo "Error: DEPLOY_USER secret is not set"; exit 1; fi
                  if [ -z "${SSH_PRIVATE_KEY:-}" ]; then echo "Error: SSH_PRIVATE_KEY secret is not set"; exit 1; fi
                  echo "SSH secrets validated"

            - name: Write SSH key to file
              if: success()
              shell: bash
              env:
                  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
              run: |
                  set -euo pipefail
                  umask 077
                  mkdir -p /tmp/sshtest
                  echo "$SSH_PRIVATE_KEY" > /tmp/sshtest/id_rsa
                  chmod 600 /tmp/sshtest/id_rsa
                  ls -la /tmp/sshtest

            - name: Populate known_hosts (optional)
              if: success()
              shell: bash
              env:
                  DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
                  SSH_PORT: ${{ secrets.SSH_PORT }}
              run: |
                  set -euo pipefail
                  PORT=${SSH_PORT:-22}
                  echo "# known host for ${DEPLOY_HOST}:${PORT}" > /tmp/sshtest/known_hosts || true
                  if command -v ssh-keyscan >/dev/null 2>&1; then
                    ssh-keyscan -p ${PORT} ${DEPLOY_HOST} >> /tmp/sshtest/known_hosts || true
                  fi
                  echo "known_hosts content:" && cat /tmp/sshtest/known_hosts || true

            - name: Local SSH connectivity test (runner)
              if: success()
              shell: bash
              env:
                  DEPLOY_HOST: ${{ secrets.DEPLOY_HOST }}
                  DEPLOY_USER: ${{ secrets.DEPLOY_USER }}
                  SSH_PORT: ${{ secrets.SSH_PORT }}
              run: |
                  set -euo pipefail
                  PORT=${SSH_PORT:-22}
                  echo "Attempting SSH to ${DEPLOY_USER}@${DEPLOY_HOST}:${PORT} from runner (timeout=10)"
                  # Use BatchMode to avoid password prompts on CI
                  timeout 10s ssh -o BatchMode=yes -o StrictHostKeyChecking=yes -i /tmp/sshtest/id_rsa -p ${PORT} ${DEPLOY_USER}@${DEPLOY_HOST} 'echo connected' || {
                    echo "SSH connection failed or timed out; this indicates either network access is blocked, the host is not reachable from GitHub Actions runners, or auth failed."
                    ssh -o BatchMode=yes -o StrictHostKeyChecking=no -i /tmp/sshtest/id_rsa -p ${PORT} ${DEPLOY_USER}@${DEPLOY_HOST} 'echo connection-attempt-without-strict-check' || true
                    exit 1
                  }

            - name: Run appleboy/ssh-action to test action path
              if: success()
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.DEPLOY_HOST }}
                  username: ${{ secrets.DEPLOY_USER }}
                  key: ${{ secrets.SSH_PRIVATE_KEY }}
                  port: ${{ secrets.SSH_PORT }}
                  script: |
                      echo "connected-via-appleboy"
                      # Optional debug
                      uname -a || true
                      id || true
